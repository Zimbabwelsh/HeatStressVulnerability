library(shiny)
library(shinydashboard)
library(shinycssloaders)
library(sf)
library(biscale)
library(cowplot)

ui <- dashboardPage(
  
  
  dashboardHeader(title="Exploring UK Heatwave Vulnerability"),
  
  
  dashboardSidebar(
    sidebarMenu(
      menuItem("Motivation", tabName="first", icon = icon("book-reader")),
      menuItem("Mapping", tabName="second", icon = icon("calculator"))
    )
  ),
    
  dashboardBody(
    tabItems(
      tabItem(
        tabName="first",
        fluidRow(column(6, 
                        box(width=12, h4("Difficulties in presenting Heatwave vulnerability"),
                            "This app is a supplement to the paper XXXX,", br(), br(),
                            "Here's a bunch of text explaining our motivation and shit.", br(), br(),
                            "We'd probably also have a bit detailing how we calculate/interpret
                            each of the climate risk variables we are presenting for display.")))
      ),
    tabItem(
        tabName="second",
        fluidRow(column(4, h4("Parameterising Climate and Social Risk"),
                        "The inputs for the graphic rendered here are calculated as follows:", br(), br(),
                        em("Ice Cream Mely Days: ICMD"), "refers to the number of days per year on which an ice cream would melt
                        before you could actually fucking finish the bastard."
        ),
        column(4,
               h4("Climate Risk Variables"),
        
        sliderInput(inputId = "num1",
                    label = "Climate Risk 1 (ICMD) Weighting",
                    min = 0.1, max = 3,value = 1, step = 0.1),
        sliderInput(inputId = "num2",
                    label = "Climate Risk 2 Weighting",
                    min = 0.1, max = 3, value= 1, step = 0.1),
        ),
        column(4,
               h4("Social Risk Variables"),
        sliderInput(inputId = "num3",
                    label = "Social Risk 1 Weighting",
                    min = 0.1, max = 3, value = 1, step = 0.1),
        sliderInput(inputId = "num4",
                    label = "Social Risk 2 Weighting",
                    min = 0.1, max = 3, value = 1, step = 0.1),
        ),
      
      # Main panel for displaying outputs ----
      mainPanel(
        column(12, (
          withSpinner(plotOutput(outputId = "biplot"))
        ))),
      )
  ),
  tabItem(tabName = "third",
          h4("Further Resources"),
          "There has been much written on how to appropriately conceptualise and parameterise heatwave vulnerability")
  
))
)


# Define server logic required to draw a histogram ----
server <- function(input, output) {
  

  output$biplot <- renderPlot({
    
    df <- sf::st_read("www/alansNips/alansNips.shp")
    df$climaterisk <- (df$climat1*input$num1 + df$climat2*input$num2)
    df$socialrisk  <- (df$ovr75ss*input$num3 + df$ppdnscl*input$num4)
    data <- bi_class(df, x = climaterisk, y = socialrisk, style = "quantile", dim = 3)
    
    map <- ggplot() +
    geom_sf(data = data, mapping = aes(fill = bi_class), colour = NA, show.legend = FALSE) +
    bi_scale_fill(pal = "DkBlue", dim = 3) +
    bi_theme() 
  
  
  legend <- bi_legend(pal = "DkBlue",
                      dim = 3,
                      xlab = "Climate Risk",
                      ylab = "Social Risk",
                      size = 8)
  
  finalPlot <- cowplot::ggdraw() +
    cowplot::draw_plot(map, 0, 0, 1, 1) +
    cowplot::draw_plot(legend, 0.05, .6, 0.3, 0.3)
  
  plot(finalPlot)
})
}

shinyApp(ui, server)

