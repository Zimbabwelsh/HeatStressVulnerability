library(shiny)
library(shinydashboard)
library(shinycssloaders)
library(sf)
library(ggplot2)
library(biscale)
library(cowplot)

ui <- dashboardPage(
  
  
  dashboardHeader(title="UK Heatwave Vulnerability"),
  
  
  dashboardSidebar(
    sidebarMenu(
      menuItem("Motivation", tabName="first", icon = icon("book-reader")),
      menuItem("Mapping", tabName="second", icon = icon("calculator"))
    )
  ),
    
  dashboardBody(
    tabItems(
      tabItem(
        tabName="first",
        fluidRow(column(6, 
                        box(width=16, h4("Motivation"),
"This app is an interactive supplement to the paper Kennedy-Asser et al., in prep.: Simuated future heat stress risk in UKCP18.", br(), br(),
                            "The UK experiences significant regional increases in mortality in response to summer heatwaves. Projected future warming is expected to increase exposure to heat stress risks. Within the UK, there will be individuals in society that are particularly vulnerable to climate hazards due to socio-economic factors.", br(), br(),
                            "The latest UK Climate Projections (UKCP18) from the UK Met. Office are used here to project changing heat extremes at 12 km spatial resolution for all regions of the UK. Four metrics of heat stress (outlined below) are used to define heat hazards for different warming scenarios. These are combined with socio-economic metrics which are used to define some key aspects of vulnerability to heat extremes.", br(), br(),
                            "Heat hazard and socio-economic vulnerability factors have been linearly transformed. The interaction of these factors is used to highlight spatial hotspots of risk associated with extreme heat, for present and future climate scenarios. This app allows the weighting applied to each of these factors in generating risk maps to be modified and the uncertainty explored. For a full description of the metrics and methods, see the associated paper.", br(), br(),
                            h4("Metrics"),
"Tmax-95+: ", br(), br(),
"VP-95+: " , br(), br(),
"Tmin-95+: " , br(), br(),
"DD66: " , br(), br(),
"%>65s: " , br(), br(),
"Pop. Dens.: " , br(), br(),
"IMD: ")))
      ),
    tabItem(
        tabName="second",
        fluidRow(column(4, h4("Parameterising Climate and Social Risk"),
                        "The inputs for the graphic rendered here are calculated as follows:", br(), br(),
                        em("Ice Cream Mely Days: ICMD"), "refers to the number of days per year on which an ice cream would melt
                        before you could actually fucking finish the bastard."
        ),
        column(4,
               h4("Weighting of Climate Risk Variables (1.5 Degree Warming Scenario)"),
        
        sliderInput(inputId = "num1",
                    label = "99th Temperature Percentile:",
                    min = 0.1, max = 3,value = 1, step = 0.1),
        sliderInput(inputId = "num2",
                    label = "Anomaly between 99th Percentile and Median Temperature:",
                    min = 0.1, max = 3, value= 1, step = 0.1)
        ),
        column(4,
               h4("Weighting of Social Risk Variables"),
        sliderInput(inputId = "num3",
                    label = "Equivalised UK IMD:",
                    min = 0.1, max = 3, value = 1, step = 0.1),
        sliderInput(inputId = "num4",
                    label = "Proportion of population over the age of 65:",
                    min = 0.1, max = 3, value = 1, step = 0.1),
        sliderInput(inputId = "num5", 
                    label = "Population Density (people per kilometre squared):",
                    min = 0.1, max = 3, value = 1, step = 0.1)
        ),
      
      # Main panel for displaying outputs ----
      mainPanel(
        column(12, (
          withSpinner(plotOutput(outputId = "biplot"))
        )))
      )
  ),
  tabItem(tabName = "third",
          h4("Further Resources"),
          "There has been much written on how to appropriately conceptualise and parameterise heatwave vulnerability")
  
))
)


# Define server logic required to draw a histogram ----
server <- function(input, output) {
  

  output$biplot <- renderPlot({
    
    df <- sf::st_read("shinydata/shinydata.shp")
    df$climaterisk <- (df$clmt_p99*input$num1 + df$clmt_var*input$num2)
    df$socialrisk  <- (df$scl_age*input$num3 + df$scl_imd*input$num4 + df$scl_dens*input$num5)
    data <- bi_class(df, x = climaterisk, y = socialrisk, style = "quantile", dim = 3)
    
    map <- ggplot2::ggplot() +
    geom_sf(data = data, mapping = aes(fill = bi_class), colour = NA, show.legend = FALSE) +
    bi_scale_fill(pal = "DkBlue", dim = 3) +
    bi_theme() 
  
  
  legend <- bi_legend(pal = "DkBlue",
                      dim = 3,
                      xlab = "Climate Risk",
                      ylab = "Social Risk",
                      size = 8)
  
  finalPlot <- cowplot::ggdraw() +
    cowplot::draw_plot(map, 0, 0, 1, 1) +
    cowplot::draw_plot(legend, 0.05, .6, 0.3, 0.3)
  
  plot(finalPlot)
})
}

shinyApp(ui, server)

