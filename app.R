library(shiny)
library(shinydashboard)
library(shinycssloaders)
library(sf)
library(pals)
library(ggplot2)
library(biscale)
library(cowplot)

ui <- dashboardPage(
  
  dashboardHeader(title="UK Heat Stress Vulnerability", titleWidth = 300),
  
  dashboardSidebar(
    sidebarMenu(
      menuItem("Mapping", tabName="first", icon = icon("calculator")),
      menuItem("Motivation", tabName="second", icon = icon("book-reader")),
      menuItem("Metrics and Methods", tabName="third", icon = icon("cog", lib = "glyphicon"))
    )
  ),
  
  dashboardBody(
    tabItems(
      tabItem(
        tabName="first",
        fluidRow(column(4, h4("Dataset selection"),
                        selectInput("scenario1", "Baseline climate", 
                                    c("Recent past", "+1.5 째C", "+2.0 째C", "+3.0 째C")),
                        selectInput("region", "Region", 
                                    c("UK", "England", "Scotland", "Wales", "Northern Ireland")),
                        selectInput("gran", "Polygon Resolution", 
                                    c("Low", " High (unavailable online)")),                        actionButton("reset", "Reset default values"),br(),br(),
                        actionButton("simulate", "Create map", class = "btn-block btn-success")
        ),
        column(4,
               h4("Weighting of climate metrics (+1.5 째C scenario)"),
               
               sliderInput(inputId = "num1",
                           label = "Extreme max. temperature",
                           min = 0.1, max = 1,value = 0.32, step = 0.01),
               sliderInput(inputId = "num2",
                           label = "Extreme vapour pressure",
                           min = 0.1, max = 1, value= 0.27, step = 0.01),
               sliderInput(inputId= "num3",
                           label = "Extreme min. temperature",
                           min=0.1, max=1, value=0.19, step=0.01),
               sliderInput(inputId="num4",
                           label="Degree Days",
                           min=0.1, max=1, value=0.22, step=0.01)
        ),
        column(4,
               h4("Weighting of socio-economic metrics"),
               sliderInput(inputId = "num5",
                           label = "Equivalised UK Index of Multiple Deprivation:",
                           min = 0.1, max = 1, value = 0.5, step = 0.01),
               sliderInput(inputId = "num6",
                           label = "Proportion of population over the age of 65:",
                           min = 0.1, max = 1, value = 0.5, step = 0.01),
               sliderInput(inputId = "num7", 
                           label = "Population Density (people per kilometre squared):",
                           min = 0.1, max = 1, value = 0.5, step = 0.01)
        ),
        
        # Main panel for displaying outputs ----
        mainPanel(
          column(12, (
            withSpinner(plotOutput(outputId = "biplot"))
          )))
        )
      ),
      
      tabItem(
        tabName="second",
        fluidRow(column(8, 
                        box(width=12, h4("Motivation"),
                            "This app is an interactive supplement to the paper Kennedy-Asser et al., in prep.:", em("Simulated future heat stress risk in UKCP18"), br(), br(),
                            "The UK experiences significant regional increases in mortality in response to summer heatwaves. Projected future warming is expected to increase exposure to heat stress risks. Within the UK, there will be individuals in society that are particularly vulnerable to climate hazards due to socio-economic factors.", br(), br(),
                            "The latest UK Climate Projections (UKCP18) from the UK Met. Office are used here to project changing heat extremes at 12 km spatial resolution for all regions of the UK. Four metrics of heat stress are used to define heat hazards for different warming scenarios. These are combined with three socio-economic metrics which are used to define some key aspects of vulnerability to heat extremes.", br(), br(),
                            "Heat hazard and socio-economic vulnerability factors have been linearly transformed. The interaction of these factors is used to highlight spatial hotspots of risk associated with extreme heat, for present and future climate scenarios. This app allows the weighting applied to each of these factors in generating risk maps to be modified and the uncertainty explored. For a full description of the metrics and methods, see the associated paper.")))
      ),
      
      tabItem(tabName = "third",
              fluidRow(column(6,box(width=12,h4("Metrics"),
                              em("Tmax-95+"), ": mean daily maximum temperature on extreme days (exceeding summer Tmax 95th percentile)", br(),br(),
                              em("VP-95+"), ": mean vapour pressure on extreme days",br(),br(),
                              em("Tmin-95+"), ": mean daily minimum temperature on extreme days" ,br(),br(), 
                              em("DD66"), ": degree days exceeding 66th percentile of sumemr Tmax" ,br(),br(), 
                              em("IMD"), ": Indices of Multiple Deprivation"  ,br(),br(),
                              em("Pop. % >65"), ": % of population aged >65"  ,br(),br(),
                              em("Pop. Dens."), ": population density"  
              )),
              column(6,box(width=12,h4("Methods"),
                           "All metrics have been linearly transformed from 0-1. Metrics are linearly combined.", br(), br(),
              ))
              ))
      )))


# Define server logic required to draw a histogram ----
server <- function(input, output) {
  
  # Allow sliders to be reset to default values from paper
  observeEvent(input$reset, {
    updateSliderInput(inputId = "num1", value = 0.32)
    updateSliderInput(inputId = "num2", value = 0.27)
    updateSliderInput(inputId = "num3", value = 0.19)
    updateSliderInput(inputId = "num4", value = 0.22)
    updateSliderInput(inputId = "num5", value = 0.5)
    updateSliderInput(inputId = "num6", value = 0.5)
    updateSliderInput(inputId = "num7", value = 0.5)
  })
  

  # Load the data as reactive variables to update only when 'Create Map' is pressed
  df <- eventReactive(input$simulate, {
    if (input$gran=="Low"){
      df <- na.omit(sf::st_read("shinydata/polyshiny8.shp"))
    }
    else{
      df <- na.omit(sf::st_read("shinydata/polyshiny350.shp"))
    }
    if (input$region=="UK"){
      df <- df
      }
    else if (input$region=="England"){
      id <- substr(df$cd,start = 1, stop = 1) == "E"
      df <- df[id,]
    }
    else if (input$region=="Scotland"){
      id <- substr(df$cd,start = 1, stop = 1) == "S"
      df <- df[id,]
    }
    else if (input$region=="Wales"){
      id <- substr(df$cd,start = 1, stop = 1) == "W"
      df <- df[id,]
    }
    else if (input$region=="Northern Ireland"){
      id <- substr(df$cd,start = 1, stop = 1) == "9"
      df <- df[id,]
    }
    })

  
  # Likewise define climate and social risk as reactive expressions
  climaterisk <- eventReactive(input$simulate, {df()$rTmax95p*input$num1 + df()$rVP95p*input$num2 + df()$rTmin95p*input$num3 + df()$rDD66p*input$num4})
  socialrisk  <- eventReactive(input$simulate, {df()$scl_imd*input$num5 + df()$scl_age*input$num6 + df()$scl_dens*input$num7})
  
  
  # Read in correct coastline
  c <- eventReactive(input$simulate, {c <- na.omit(sf::st_read("shinydata/uk200.shp"))
  if (input$region=="UK"){c <- c}
  else if (input$region=="England"){
    id2 <- substr(c$ctry19cd,start = 1, stop = 1) == "E"
    c <- c[id2,]
  }
  else if (input$region=="Scotland"){
    id2 <- substr(c$ctry19cd,start = 1, stop = 1) == "S"
    c <- c[id2,]
  }
  else if (input$region=="Wales"){
    id2 <- substr(c$ctry19cd,start = 1, stop = 1) == "W"
    c <- c[id2,]
  }
  else if (input$region=="Northern Ireland"){
    id2 <- substr(c$ctry19cd,start = 1, stop = 1) == "N"
    c <- c[id2,]
  }
  })
  
  
  # Generate the plot
  output$biplot <- renderPlot({
    df2 <- df()
    c2 <- c()
    df2$climaterisk <- climaterisk()
    df2$socialrisk <- socialrisk()
    data <- bi_class(df2, x = climaterisk, y = socialrisk, style = "quantile", dim = 3)
    
    custom_pal <- bi_pal_manual(val_1_1="#e8e8e8", val_1_2 = "#e4d9ac", val_1_3 = "#c8b35a", 
                                val_2_1="#cbb8d7", val_2_2 = "#c8ada0", val_2_3 = "#af8e53",
                                val_3_1="#9972af", val_3_2 = "#976b82", val_3_3 = "#804d36")
    
    map <- ggplot2::ggplot() +
      geom_sf(data = data, mapping = aes(fill = bi_class), colour = NA, show.legend = FALSE) +
      bi_scale_fill(pal = custom_pal, dim = 3) +
      bi_theme() +
      geom_sf(data = c2, fill = NA, size = 0.5)
    
    legend <- bi_legend(pal = custom_pal,
                        dim = 3,
                        xlab = "Climate Hazard",
                        ylab = "Social Vulnerability",
                        size = 8)
    
    finalPlot <- cowplot::ggdraw() +
      cowplot::draw_plot(map, 0, 0, 1, 1) +
      cowplot::draw_plot(legend, 0.7, 0.7, 0.3, 0.3)
    
    plot(finalPlot)
  })
}

shinyApp(ui, server)

