require(raster)
require(psych)
require(here)

names <- c("Tmax95_past", "VP95_past", "Tmin95_past", "DD66_past")

## Set seed for reproducibility
set.seed(1337)

## Read in netcdf layers as single column dataframes
## NB "here" calls from top layer of current project, so run script from within heatStress shared folder.
for (i in names){
  data  <- raster(here("heat_hazards_2.nc"), varname = i)
  name <- paste0(i)
  assign(name, as.data.frame(values(data)))
}

## combine dataframes and rename columns
df <- na.omit(data.frame(Tmax95_past, VP95_past, Tmin95_past, DD66_past))
colnames(df) <- names

## Generate raw correlation matrix
HScor <- cor(df)

## Run parallel analysis for appropriate component/factor N
PA.HS = fa.parallel(df, fm="wls", n.iter=50, quant=.95, fa="both") 
save(PA.HS, file = "PA.HS.Rdata")
eigen(HScor)$values                   #Eigenvalues of data from eigen function
PA.HS$pc.values                       #Equivalent results from principal components PA 
PA.HS$fa.values                       #Eigenvalues of common factor model

#Indicates 2-factor solution if criterion > random noise, or single factor if EV>1 criterion. For our purposes, 1-fac is best.

## Single component/factor solutions 
pc <-  principal(df, 1, residuals=T)
mr <-         fa(df, 1)

## Compare loadings
loadings.1fac <- cbind(round(pc$loadings,2), round(mr$loadings,2))
loadings.1fac

## Compare component loadings with scores
round(cor(df, pc$scores),2)

## Compare factor loadings with scores
round(cor(df, mr$scores),2)

## Specify orthogonal 2-component Principal Component, Minres FA (principal axis and WLS are identical solutions)
pc2 <- principal(df, 2, rotate = "geominT", residuals=T)
mr2 <-        fa(df, 2, rotate = "geominT")

## For 2 latent solutions compare factor congruence
round(factor.congruence(list(pc2, mr2)),2)

## compare loadings across 2 factor solutions
loadings.2fac <- cbind(round(pc2$loadings, 2), round(mr2$loadings, 2))
loadings.2fac

## Given measurement error - optimal solution is to select from the following:
# Select from PC1 if want to treat climate model as observation without measurement error
# Select from MR1 if want to treat climate model as observation with unique variances for each element.
loadings.1fac
# 
# ## Specify correlated unidimensional factor model (lavaan)
# factor.model <- " climate1 =~ Tmax95_past + VP95_past + Tmin95_past + DD66_past"
# fit <- cfa(factor.model, data=df, std.lv=T)
# 
# ## Inspect output 
# summary(fit, standardized=TRUE)
# Heywood case from the (true) dependency of input variables.
